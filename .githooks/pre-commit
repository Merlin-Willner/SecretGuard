#!/usr/bin/env sh
set -eu

root="$(git rev-parse --show-toplevel 2>/dev/null || true)"
if [ -z "$root" ]; then
    exit 0
fi

cd "$root"

if [ ! -x "./secretguard" ]; then
    echo "secretguard: binary not found; run 'make' first." >&2
    exit 1
fi

files="$(git diff --cached --name-only --diff-filter=ACM)"
if [ -z "$files" ]; then
    exit 0
fi

found=0
locations=""
while IFS= read -r file; do
    [ -z "$file" ] && continue
    [ -f "$file" ] || continue

    json="$(./secretguard --json "$file")" || exit 2
    count="$(printf '%s' "$json" | sed -n 's/.*"findings":\([0-9][0-9]*\).*/\1/p' | head -n1)"
    if [ -z "$count" ]; then
        echo "secretguard: could not parse JSON output for $file" >&2
        exit 2
    fi

    if [ "$count" -gt 0 ]; then
        found=$((found + count))
        locs="$(printf '%s' "$json" | tr '{' '\n' | sed -n 's/.*"severity":"\([^"]*\)","rule":"\([^"]*\)","file":"\([^"]*\)","line":\([0-9][0-9]*\),"col":\([0-9][0-9]*\).*/\3:\4:\5 [\1] \2/p')"
        if [ -n "$locs" ]; then
            while IFS= read -r loc; do
                if [ -z "$locations" ]; then
                    locations="- $loc"
                else
                    locations="${locations}\n- $loc"
                fi
            done <<EOF
$locs
EOF
        fi
    fi
done <<EOF
$files
EOF

if [ "$found" -gt 0 ]; then
    echo "secretguard: $found finding(s) detected in staged files." >&2
    if [ -n "$locations" ]; then
        printf "%b\n" "$locations" >&2
    fi
    echo "Commit blocked." >&2
    exit 1
fi
